name: Build Coturn Windows

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1. Clone Coturn repository
      - name: Clone Coturn repository
        shell: powershell
        run: |
          git clone https://github.com/coturn/coturn.git coturn

      # 2. Install vcpkg and dependencies
      - name: Install vcpkg and dependencies
        shell: powershell
        run: |
          git clone https://github.com/microsoft/vcpkg.git vcpkg
          cd vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg install openssl:x64-windows libevent:x64-windows sqlite3:x64-windows libpq:x64-windows hiredis:x64-windows mongo-c-driver:x64-windows utf8proc:x64-windows lz4:x64-windows pthreads:x64-windows pkgconf:x64-windows vcpkg-cmake:x64-windows

      # 3. Configure Coturn build with CMake
      - name: Configure Coturn with CMake
        shell: powershell
        run: |
          md coturn\build
          cd coturn\build
          cmake .. -DCMAKE_TOOLCHAIN_FILE=..\vcpkg\scripts\buildsystems\vcpkg.cmake -DCMAKE_BUILD_TYPE=Release

      # 4. Build Coturn using MSBuild (via vswhere)
      - name: Build Coturn
        shell: powershell
        run: |
          $vsPath = & "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe" -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
          $msbuild = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"

          if (!(Test-Path $msbuild)) {
              Write-Error "MSBuild not found!"
              exit 1
          }

          cd coturn\build
          & $msbuild ALL_BUILD.vcxproj /p:Configuration=Release /m

      # 5. Archive the build outputs
      - name: Archive Coturn build
        shell: powershell
        run: |
          cd coturn\build\Release
          $archiveName = "$(GitHub.RunNumber)-coturn-win-x64.zip"
          Compress-Archive -Path *.exe, *.dll -DestinationPath "..\..\$archiveName"
          Write-Host "Archive created: $archiveName"

      # 6. Upload the artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: coturn-win-x64
          path: coturn\$archiveName
